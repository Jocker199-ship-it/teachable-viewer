<!DOCTYPE html>
<html>
<head>
    <title>Teachable Machine Viewer (local upload)</title>
</head>
<body>
    <h1>Teachable Machine: Local Model Test</h1>
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ <code>model.json</code> –∏ <code>metadata.json</code> –∏–∑ Teachable Machine</p>

    <input type="file" id="model-json" accept="application/json"> model.json<br><br>
    <input type="file" id="metadata-json" accept="application/json"> metadata.json<br><br>
    <button onclick="loadModel()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</button>

    <h3>üìã –°—Ç–∞—Ç—É—Å:</h3>
    <div id="status"></div>

    <h3>üì∑ –í–µ–±–∫–∞–º–µ—Ä–∞:</h3>
    <div id="webcam-container"></div>

    <h3>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
    <div id="label-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

    <script>
        let model, webcam, labelContainer, maxPredictions;

        async function loadModel() {
            const status = document.getElementById("status");
            status.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...";
            try {
                const modelFile = document.getElementById("model-json").files[0];
                const metadataFile = document.getElementById("metadata-json").files[0];

                if (!modelFile || !metadataFile) {
                    status.innerText = "–û—à–∏–±–∫–∞: –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –æ–±–∞ —Ñ–∞–π–ª–∞ (model.json –∏ metadata.json)";
                    return;
                }

                model = await tmImage.loadFromFiles(modelFile, metadataFile);
                maxPredictions = model.getTotalClasses();
                status.innerText = "‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.";

                await setupWebcam();
                window.requestAnimationFrame(loop);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏:", error);
                status.innerText = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error.message;
            }
        }

        async function setupWebcam() {
            const flip = true;
            webcam = new tmImage.Webcam(200, 200, flip);
            await webcam.setup();
            await webcam.play();

            document.getElementById("webcam-container").appendChild(webcam.canvas);

            labelContainer = document.getElementById("label-container");
            labelContainer.innerHTML = "";
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerText = classPrediction;
            }
        }
    </script>
</body>
</html>
